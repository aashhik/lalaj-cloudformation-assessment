# Create bucket
aws s3api create-bucket \
  --bucket test-bucket-cf \
  --region us-east-1

aws s3 cp ./cf-templates/vpc.yaml s3://test-bucket-lalaj-cf/

aws s3 cp ./cf-templates/ecs.yaml s3://test-bucket-lalaj-cf/

# Create Administration and Execution Role

aws cloudformation create-stack \
  --stack-name createCloudFormationStackSetAdministrationRole \
  --template-url https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetAdministrationRole.yml \
  --capabilities CAPABILITY_NAMED_IAM 


aws cloudformation create-stack \
  --stack-name createCloudFormationStackSetExecutionRole \
  --template-url https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetExecutionRole.yml \
  --parameters ParameterKey=AdministratorAccountId,ParameterValue=144947567756 \
  --capabilities CAPABILITY_NAMED_IAM


# Create stackset

aws cloudformation create-stack-set \
  --stack-set-name testStackSet \
  --template-body file://vpc.yaml \
  --permission-model SELF_MANAGED \
  --administration-role-arn arn:aws:iam::144947567756:role/AWSCloudFormationStackSetAdministrationRole \
  --execution-role-name AWSCloudFormationStackSetExecutionRole \
  --capabilities CAPABILITY_NAMED_IAM \
  --description "Self-managed StackSet for multiple accounts"

--> store stacksetid in env using jq, since output is in json ==> MyStackSet:5ddcc02a-5d0e-451f-95de-97da8fcbecc9


aws cloudformation create-stack-instances \
  --stack-set-name testStackSet \
  --accounts 144947567756 \
  --regions us-west-2 \
  --parameter-overrides ParameterKey=vpcCidrBlock,ParameterValue=172.20.0.0/16


--> Get operation ID from previous commandâ€™s output and check progress, since output is in json => d11bde00-ee22-46f6-959d-a7107abb916f

aws cloudformation describe-stack-set-operation \
  --stack-set-name MyStackSet \
  --operation-id d11bde00-ee22-46f6-959d-a7107abb916f


# Update StackSet template
aws cloudformation update-stack-set \
  --stack-set-name MyStackSet \
  --template-body file://vpc.yaml \
  --capabilities CAPABILITY_NAMED_IAM

# Delete deployed stacks
aws cloudformation delete-stack-instances \
  --stack-set-name MyStackSet \
  --accounts 144947567756 \
  --regions us-west-2 \
  --no-retain-stacks

# Delete the StackSet itself

aws cloudformation delete-stack-set \
  --stack-set-name MyStackSet
